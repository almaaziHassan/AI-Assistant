generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User roles for access control
enum UserRole {
  customer
  staff
  admin
}

// User model for authentication
model User {
  id                   String        @id @default(uuid())
  email                String        @unique
  passwordHash         String?       @map("password_hash")
  name                 String
  phone                String?
  role                 UserRole      @default(customer)
  googleId             String?       @unique @map("google_id")
  emailVerified        Boolean       @default(false) @map("email_verified")
  verificationToken    String?       @unique @map("verification_token")
  verificationExpires  DateTime?     @map("verification_expires") @db.Timestamptz(6)
  resetToken           String?       @unique @map("reset_token")
  resetTokenExpires    DateTime?     @map("reset_token_expires") @db.Timestamptz(6)
  lastLogin            DateTime?     @map("last_login") @db.Timestamptz(6)
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  appointments         Appointment[]
  conversations        Conversation[]
  contactProfile       ContactProfile?

  @@index([email], map: "idx_users_email")
  @@index([googleId], map: "idx_users_google_id")
  @@index([verificationToken], map: "idx_users_verification_token")
  @@index([resetToken], map: "idx_users_reset_token")
  @@map("users")
}

model ContactProfile {
  id          String   @id @default(uuid())
  email       String   @unique  // The logical key for Guests
  userId      String?  @unique  @map("user_id") // Direct link if they are a registered User
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  phone       String?
  tags        Json?    @default("[]") // ["vip", "difficult", "monday-regular"]
  notes       String?  // Internal admin notes: "Customer likes coffee"
  isBlocked   Boolean  @default(false) @map("is_blocked")
  
  lastSeenAt  DateTime? @map("last_seen_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([email], map: "idx_contact_profile_email")
  @@map("contact_profiles")
}

model Staff {
  id             String           @id @default(uuid())
  name           String
  email          String?
  phone          String?
  role           String?          @default("staff")
  color          String?
  isActive       Boolean?         @default(true) @map("is_active")
  createdAt      DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  services       Json?            @default("[]")
  schedule       Json?
  appointments   Appointment[]
  staff_services staff_services[]
  waitlist       Waitlist[]

  @@index([isActive], map: "idx_staff_active")
  @@map("staff")
}

model Service {
  id             String           @id
  name           String
  description    String?
  duration       Int
  price          Decimal          @default(0) @db.Decimal(10, 2)
  isActive       Boolean?         @default(true) @map("is_active")
  displayOrder   Int?             @default(0) @map("display_order")
  createdAt      DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  staff_services staff_services[]

  @@index([isActive], map: "idx_services_active")
  @@map("services")
}

model Location {
  id           String        @id @default(uuid())
  name         String
  address      String?
  phone        String?
  isActive     Boolean?      @default(true) @map("is_active")
  createdAt    DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  appointments Appointment[]

  @@index([isActive], map: "idx_locations_active")
  @@map("locations")
}

model Holiday {
  id               String    @id @default(uuid())
  date             DateTime  @unique @db.Date
  name             String
  isClosed         Boolean?  @default(true) @map("is_closed")
  customHoursOpen  DateTime? @map("custom_hours_open") @db.Time(6)
  customHoursClose DateTime? @map("custom_hours_close") @db.Time(6)
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("holidays")
}

model Appointment {
  id              String    @id @default(uuid())
  customerName    String    @map("customer_name")
  customerEmail   String    @map("customer_email")
  customerPhone   String    @map("customer_phone")
  serviceId       String    @map("service_id")
  serviceName     String    @map("service_name")
  staffId         String?   @map("staff_id")
  staffName       String?   @map("staff_name")
  appointmentDate DateTime  @map("appointment_date") @db.Date
  appointmentTime DateTime  @map("appointment_time") @db.Time(6)
  duration        Int
  status          String?   @default("confirmed")
  locationId      String?   @map("location_id")
  userId          String?   @map("user_id")
  notes           String?
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  location        Location? @relation(fields: [locationId], references: [id], onUpdate: NoAction)
  staff           Staff?    @relation(fields: [staffId], references: [id], onUpdate: NoAction)
  user            User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([appointmentDate], map: "idx_appointments_date")
  @@index([appointmentDate, staffId, status], map: "idx_appointments_date_staff_status")
  @@index([customerEmail], map: "idx_appointments_email")
  @@index([staffId], map: "idx_appointments_staff")
  @@index([status, appointmentDate], map: "idx_appointments_status_date")
  @@index([userId], map: "idx_appointments_user")
  @@map("appointments")
}

model Conversation {
  id          String    @id @default(uuid())
  sessionId   String    @map("session_id")
  role        String
  content     String
  messageType String?   @default("text") @map("message_type")
  actionType  String?   @map("action_type")
  actionData  Json?     @map("action_data")
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  userId      String?   @map("user_id")
  user        User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([sessionId], map: "idx_conversations_session")
  @@index([userId], map: "idx_conversations_user")
  @@map("conversations")
}

model Waitlist {
  id            String    @id @default(uuid())
  customerName  String    @map("customer_name")
  customerEmail String    @map("customer_email")
  customerPhone String    @map("customer_phone")
  serviceId     String    @map("service_id")
  preferredDate DateTime  @map("preferred_date") @db.Date
  preferredTime DateTime? @map("preferred_time") @db.Time(6)
  staffId       String?   @map("staff_id")
  status        String?   @default("waiting")
  notifiedAt    DateTime? @map("notified_at") @db.Timestamptz(6)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  staff         Staff?    @relation(fields: [staffId], references: [id], onUpdate: NoAction)

  @@index([preferredDate], map: "idx_waitlist_date")
  @@map("waitlist")
}

model Callback {
  id            String    @id @default(uuid())
  customerName  String    @map("customer_name")
  customerPhone String    @map("customer_phone")
  customerEmail String?   @map("customer_email")
  preferredTime String?   @map("preferred_time")
  concerns      String?
  status        String?   @default("pending")
  notes         String?
  calledAt      DateTime? @map("called_at") @db.Timestamptz(6)
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([customerPhone], map: "idx_callbacks_phone")
  @@index([status], map: "idx_callbacks_status")
  @@map("callbacks")
}

model staff_services {
  staff_id   String
  service_id String
  services   Service @relation(fields: [service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  staff      Staff   @relation(fields: [staff_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([staff_id, service_id])
}

model FAQ {
  id           String    @id @default(uuid())
  question     String
  answer       String
  keywords     Json?     @default("[]")
  displayOrder Int?      @default(0) @map("display_order")
  isActive     Boolean?  @default(true) @map("is_active")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive], map: "idx_faqs_active")
  @@map("faqs")
}

model SystemSetting {
  key         String    @id
  value       Json
  description String?
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("system_settings")
}

model KnowledgeDoc {
  id        String    @id @default(uuid())
  title     String
  content   String
  tags      Json?     @default("[]")
  metadata  Json?     @default("{}")
  embedding Json?     // Vector embeddings [0.12, 0.33, ...]
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive], map: "idx_knowledge_docs_active")
  @@map("knowledge_docs")
}
